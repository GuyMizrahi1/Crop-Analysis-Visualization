<!DOCTYPE html>
<html>
<head>
    <title>Visualization 1: Data Collection Overview</title>
    
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
        color: #333;
    }
    h1 {
        text-align: center;
        color: #1b5e20;
        margin-bottom: 10px;
        font-size: 2.2em;
    }
    h2 {
        color: white;
        margin-top: 50px;
        padding: 15px;
        background: linear-gradient(90deg, #228B22, #32CD32);
        border-radius: 5px;
    }
    h3 {
        color: #1b5e20;
        margin-top: 30px;
        border-left: 4px solid #228B22;
        padding-left: 15px;
    }
    .subtitle {
        text-align: center;
        color: #666;
        font-size: 1.1em;
        margin-bottom: 30px;
    }
    .analysis-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .intro-box {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border: 2px solid #4CAF50;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .discovery-box {
        background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        border: 3px solid #2E7D32;
        padding: 25px;
        border-radius: 10px;
        margin: 25px 0;
    }
    .discovery-box h3 {
        color: #1b5e20;
        margin-top: 0;
        border: none;
        padding-left: 0;
    }
    .flow-arrow {
        text-align: center;
        font-size: 40px;
        color: #228B22;
        margin: 30px 0;
    }
    .methodology {
        background: #e8f4fd;
        border-left: 4px solid #1f77b4;
        padding: 15px 20px;
        margin-top: 15px;
        border-radius: 0 8px 8px 0;
    }
    .methodology h4 {
        margin: 0 0 10px 0;
        color: #333;
    }
    .key-observations {
        background: #f8f9fa;
        border-left: 4px solid #2ca02c;
        padding: 15px 20px;
        margin-top: 15px;
        border-radius: 0 8px 8px 0;
    }
    .key-observations h4 {
        margin: 0 0 10px 0;
        color: #333;
    }
    .key-observations ul {
        margin: 0;
        padding-left: 20px;
    }
    .key-observations li {
        margin-bottom: 8px;
        line-height: 1.5;
    }
    .warning-box {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px 20px;
        margin-top: 15px;
        border-radius: 0 8px 8px 0;
    }
    table {
        border-collapse: collapse;
        margin: 15px auto;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px 12px;
        text-align: left;
    }
    th {
        background: linear-gradient(180deg, #e8f5e9, #c8e6c9);
        color: #1b5e20;
    }
    .treatment-table th {
        background: linear-gradient(180deg, #e8f5e9, #c8e6c9);
    }
    .timestamp {
        text-align: center;
        color: #666;
        margin-top: 40px;
        font-size: 0.9em;
    }
</style>

</head>
<body>
    <h1>NIR (Near Infrared) Spectroscopy Dataset: 4 Crops, 4 Locations, 7,500+ Samples</h1>
    <p class="subtitle">Leaf samples with 1,557 spectral wavelengths and chemical values: N (Nitrogen), ST (Starch), SC (Soluble Carbohydrates) | 2021-2024</p>

    <div class="analysis-section">
        <table class="treatment-table" style="width: 100%;"><tr><th>Crop</th><th>Total Samples</th><th>Date Range</th><th>Unique Dates</th></tr><tr><td style="color: #E69F00; font-weight: bold;">Citrus</td><td>2882</td><td>Nov 2021 - Aug 2024</td><td>37</td></tr><tr><td style="color: #8B4513; font-weight: bold;">Almond</td><td>2503</td><td>May 2018 - Nov 2023</td><td>22</td></tr><tr><td style="color: #009E73; font-weight: bold;">Avocado</td><td>1848</td><td>Oct 2019 - Jul 2024</td><td>29</td></tr><tr><td style="color: #CC79A7; font-weight: bold;">Vine</td><td>315</td><td>Aug 2020 - Jun 2022</td><td>4</td></tr></table>
        <div>                        <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.3.0.min.js" integrity="sha256-bO3dS6yCpk9aK4gUpNELtCiDeSYvGYnK7jFI58NQnHI=" crossorigin="anonymous"></script>                <div id="e8cf3f6f-ae72-4f4c-ada2-5c030184477a" class="plotly-graph-div" style="height:500px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("e8cf3f6f-ae72-4f4c-ada2-5c030184477a")) {                    Plotly.newPlot(                        "e8cf3f6f-ae72-4f4c-ada2-5c030184477a",                        [{"hovertemplate":"Citrus\u003cbr\u003e%{x|%B %Y}\u003cbr\u003eSamples: %{y}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#E69F00"},"name":"Citrus","x":["2021-11-01T00:00:00","2022-03-01T00:00:00","2022-04-01T00:00:00","2022-05-01T00:00:00","2022-06-01T00:00:00","2022-07-01T00:00:00","2022-08-01T00:00:00","2022-09-01T00:00:00","2022-10-01T00:00:00","2022-11-01T00:00:00","2022-12-01T00:00:00","2023-01-01T00:00:00","2023-02-01T00:00:00","2023-03-01T00:00:00","2023-04-01T00:00:00","2023-05-01T00:00:00","2023-06-01T00:00:00","2023-07-01T00:00:00","2023-08-01T00:00:00","2023-09-01T00:00:00","2023-10-01T00:00:00","2023-11-01T00:00:00","2023-12-01T00:00:00","2024-01-01T00:00:00","2024-02-01T00:00:00","2024-03-01T00:00:00","2024-04-01T00:00:00","2024-05-01T00:00:00","2024-07-01T00:00:00","2024-08-01T00:00:00"],"y":{"dtype":"i2","bdata":"RABLAEsARwC6AEsAugBLACwBSwBLAFAASwBLAJYASwBzAEsAXwBzAEsASwBLAEsASwBLAFsASwBLAEsA"},"type":"bar"},{"hovertemplate":"Almond\u003cbr\u003e%{x|%B %Y}\u003cbr\u003eSamples: %{y}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#8B4513"},"name":"Almond","x":["2018-05-01T00:00:00","2018-06-01T00:00:00","2018-07-01T00:00:00","2018-08-01T00:00:00","2018-09-01T00:00:00","2018-10-01T00:00:00","2021-10-01T00:00:00","2022-04-01T00:00:00","2022-05-01T00:00:00","2022-06-01T00:00:00","2022-07-01T00:00:00","2022-08-01T00:00:00","2022-09-01T00:00:00","2022-11-01T00:00:00","2023-05-01T00:00:00","2023-06-01T00:00:00","2023-07-01T00:00:00","2023-09-01T00:00:00","2023-11-01T00:00:00"],"y":{"dtype":"i2","bdata":"VQBmAGwAaQBQAG8ADwCgAPAA8AB3AHcAbQBzAHMA3QBpAHcAbwA="},"type":"bar"},{"hovertemplate":"Avocado\u003cbr\u003e%{x|%B %Y}\u003cbr\u003eSamples: %{y}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#009E73"},"name":"Avocado","x":["2019-10-01T00:00:00","2020-06-01T00:00:00","2020-10-01T00:00:00","2021-10-01T00:00:00","2022-05-01T00:00:00","2022-06-01T00:00:00","2022-07-01T00:00:00","2022-08-01T00:00:00","2022-09-01T00:00:00","2022-10-01T00:00:00","2022-11-01T00:00:00","2023-03-01T00:00:00","2023-04-01T00:00:00","2023-05-01T00:00:00","2023-06-01T00:00:00","2023-08-01T00:00:00","2023-09-01T00:00:00","2023-11-01T00:00:00","2023-12-01T00:00:00","2024-06-01T00:00:00","2024-07-01T00:00:00"],"y":{"dtype":"i2","bdata":"FAAXABUAIgClANcApQClAKMAMgAeANQAMgClAJoANwACADcAMgAEADIA"},"type":"bar"},{"hovertemplate":"Vine\u003cbr\u003e%{x|%B %Y}\u003cbr\u003eSamples: %{y}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#CC79A7"},"name":"Vine","x":["2020-08-01T00:00:00","2021-07-01T00:00:00","2021-10-01T00:00:00","2022-06-01T00:00:00"],"y":{"dtype":"i1","bdata":"VFRQQw=="},"type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"title":{"font":{"size":16},"text":"1.1 Sample Leaves Collection Timeline: Monthly counts by crop (2021-2024)"},"xaxis":{"title":{"text":"Collection Date"},"tickformat":"%b %Y","dtick":"M3","range":["2018-04-01","2024-10-31"],"tickangle":-45},"legend":{"orientation":"h","yanchor":"top","y":-0.35,"xanchor":"center","x":0.5,"title":{"text":"Crop Type"}},"margin":{"b":150},"yaxis":{"title":{"text":"Number of Samples"}},"barmode":"group","height":500,"hovermode":"x unified"},                        {"responsive": true}                    )                };            </script>        </div>
    </div>

    <div class="analysis-section">
        <div>                            <div id="3bda67d2-cac1-43a0-a728-57cb821157d8" class="plotly-graph-div" style="height:500px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("3bda67d2-cac1-43a0-a728-57cb821157d8")) {                    Plotly.newPlot(                        "3bda67d2-cac1-43a0-a728-57cb821157d8",                        [{"hovertemplate":"Citrus\u003cbr\u003e%{x}\u003cbr\u003eSamples: %{y}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#E69F00"},"name":"Citrus","x":["January","February","March","April","May","June","July","August","September","October","November","December"],"y":{"dtype":"i2","bdata":"mwCWAOEAPAHdAC0B4QBkAb4AdwHaAJYA"},"type":"bar"},{"hovertemplate":"Almond\u003cbr\u003e%{x}\u003cbr\u003eSamples: %{y}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#8B4513"},"name":"Almond","x":["January","February","March","April","May","June","July","August","September","October","November","December"],"y":{"dtype":"i2","bdata":"AAAAAAAAoAC4ATMCTAHgADQBfgDiAAAA"},"type":"bar"},{"hovertemplate":"Avocado\u003cbr\u003e%{x}\u003cbr\u003eSamples: %{y}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#009E73"},"name":"Avocado","x":["January","February","March","April","May","June","July","August","September","October","November","December"],"y":{"dtype":"i2","bdata":"AAAAANQAMgBKAYwB1wDcAKUAfQBVADIA"},"type":"bar"},{"hovertemplate":"Vine\u003cbr\u003e%{x}\u003cbr\u003eSamples: %{y}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#CC79A7"},"name":"Vine","x":["January","February","March","April","May","June","July","August","September","October","November","December"],"y":{"dtype":"i1","bdata":"AAAAAABDVFQAUAAA"},"type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"tickangle":-45,"categoryorder":"array","categoryarray":["January","February","March","April","May","June","July","August","September","October","November","December"],"title":{"text":"Month"}},"title":{"font":{"size":16},"text":"1.2 Seasonal Distribution (DOY): Aggregated by Day-of-Year to reveal seasonal patterns\u003cbr\u003e\u003csup\u003eCitrus has full 12-month coverage (150+ samples\u002fmonth) --\u003e Primary focus for subsequent analysis\u003c\u002fsup\u003e"},"yaxis":{"title":{"text":"Number of Samples"},"range":[0,600]},"legend":{"orientation":"h","yanchor":"top","y":-0.35,"xanchor":"center","x":0.5,"title":{"text":"Crop Type"}},"margin":{"b":150},"barmode":"group","height":500,"hovermode":"x unified"},                        {"responsive": true}                    )                };            </script>        </div>
    </div>

    <div class="analysis-section">
        <h3 style="color: #1B5E20; margin-bottom: 5px;">1.3 Geographic Distribution: 4 Research Sites Across Israel (North to South)</h3>
        <p style="font-size: 13px; color: #555; margin-bottom: 15px;">Pie charts show crop distribution per location. Circle size reflects total sample count. <span style="color: #888;"><br>(Click city name to show sample counts per crop, click pie segment to see crop distribution across all sites)</span></p>
        <div style="display: flex; justify-content: center; align-items: flex-start; gap: 0; position: relative;">
            <div style="position: relative;">
                
    <style>
        .count-label-single { pointer-events: none !important; }
        .count-label-single * { pointer-events: none !important; }
    </style>
    <div id="israel-map" style="height: 550px; width: 550px; border-radius: 8px; margin: 0;"></div>
    <div id="crop-info-panel" style="display: none; position: absolute; top: 50px; left: -320px; background: rgba(255,255,255,0.98); padding: 15px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.2); z-index: 1000; min-width: 200px;"></div>
    <div style="display: flex; justify-content: center; gap: 25px; margin-top: 15px; font-size: 14px;">
        <span><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #E69F00; margin-right: 6px; vertical-align: middle;"></span>Citrus</span>
        <span><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #8B4513; margin-right: 6px; vertical-align: middle;"></span>Almond</span>
        <span><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #009E73; margin-right: 6px; vertical-align: middle;"></span>Avocado</span>
        <span><span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: #CC79A7; margin-right: 6px; vertical-align: middle;"></span>Vine</span>
    </div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        (function() {
            const locationsData = {"Gilat": {"lat": 31.3358, "lon": 34.6536, "description": "Gilat Research Station - Major agricultural research center in the Negev"}, "Kedma": {"lat": 31.6214, "lon": 34.7847, "description": "Kedma - Central Israel agricultural area"}, "Kabri": {"lat": 33.0167, "lon": 35.1333, "description": "Kabri - Northern Israel, Western Galilee"}, "Kfar Menahem": {"lat": 31.7333, "lon": 34.8333, "description": "Kfar Menahem - Coastal plain agricultural region"}};
            const locTotals = {"Gilat": 3792, "Kabri": 1315, "Kedma": 1897, "Kfar Menahem": 544};
            const cropDist = {"Gilat": {"Citrus": 2370, "Almond": 606, "Avocado": 501, "Vine": 315}, "Kabri": {"Citrus": 0, "Almond": 0, "Avocado": 1315, "Vine": 0}, "Kedma": {"Citrus": 0, "Almond": 1897, "Avocado": 0, "Vine": 0}, "Kfar Menahem": {"Citrus": 512, "Almond": 0, "Avocado": 32, "Vine": 0}};
            const labelOffsets = {"Kabri": {"x": 100, "y": -15, "arrow": "left", "padding": "8px 14px", "zIndex": 100, "latOffset": 0, "lonOffset": 0, "rotation": 0}, "Kfar Menahem": {"x": -220, "y": -20, "arrow": "right", "padding": "8px 20px", "zIndex": 300, "latOffset": 0.02, "lonOffset": 0, "rotation": 0}, "Kedma": {"x": 110, "y": -15, "arrow": "left", "padding": "8px 14px", "zIndex": 200, "latOffset": -0.06, "lonOffset": 0, "rotation": 0}, "Gilat": {"x": -180, "y": -15, "arrow": "right", "padding": "8px 14px", "zIndex": 100, "latOffset": -0.06, "lonOffset": 0, "rotation": -60}};

            // Crop colors matching the project color scheme
            const cropColors = {
                'Citrus': '#E69F00',
                'Almond': '#8B4513',
                'Avocado': '#009E73',
                'Vine': '#CC79A7'
            };

            // State: track which locations are showing detailed view
            const locationStates = {};
            Object.keys(locationsData).forEach(loc => locationStates[loc] = 'total');

            // Store references to markers for updating
            const pieMarkers = {};
            const countMarkers = {};

            // Function to create SVG pie chart with clickable segments
            function createPieChartSvg(cropData, radius, locName, showLabels = false) {
                const total = Object.values(cropData).reduce((a, b) => a + b, 0);
                if (total === 0) return '';

                const cx = radius;
                const cy = radius;
                // Apply rotation offset for this location (default -60 = start from top)
                const rotationOffset = labelOffsets[locName]?.rotation || 0;
                let startAngle = -60 + rotationOffset;

                let svg = `<svg width="${radius*2}" height="${radius*2}" viewBox="0 0 ${radius*2} ${radius*2}" style="display: block; cursor: pointer;">`;
                svg += `<circle cx="${cx}" cy="${cy}" r="${radius-1}" fill="white" stroke="white" stroke-width="2"/>`;

                const crops = ['Citrus', 'Almond', 'Avocado', 'Vine'];
                const activeCrops = crops.filter(crop => (cropData[crop] || 0) > 0);

                if (activeCrops.length === 1) {
                    const crop = activeCrops[0];
                    const count = cropData[crop];
                    svg += `<circle cx="${cx}" cy="${cy}" r="${radius-2}" fill="${cropColors[crop]}" stroke="white" stroke-width="0.5"
                            data-crop="${crop}" data-location="${locName}" class="pie-segment" style="cursor: pointer;"/>`;
                    if (showLabels) {
                        svg += `<text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="middle"
                                fill="white" font-size="14" font-weight="bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.8); pointer-events: none;">${count}</text>`;
                    }
                } else {
                    const labelPositions = [];
                    crops.forEach(crop => {
                        const count = cropData[crop] || 0;
                        if (count > 0) {
                            const angle = (count / total) * 360;
                            const endAngle = startAngle + angle;
                            const startRad = (startAngle * Math.PI) / 180;
                            const endRad = (endAngle * Math.PI) / 180;
                            const x1 = cx + (radius - 2) * Math.cos(startRad);
                            const y1 = cy + (radius - 2) * Math.sin(startRad);
                            const x2 = cx + (radius - 2) * Math.cos(endRad);
                            const y2 = cy + (radius - 2) * Math.sin(endRad);
                            const largeArc = angle > 180 ? 1 : 0;
                            const path = `M ${cx} ${cy} L ${x1} ${y1} A ${radius-2} ${radius-2} 0 ${largeArc} 1 ${x2} ${y2} Z`;
                            svg += `<path d="${path}" fill="${cropColors[crop]}" stroke="white" stroke-width="0.5"
                                    data-crop="${crop}" data-location="${locName}" class="pie-segment" style="cursor: pointer;"/>`;

                            if (showLabels) {
                                const midAngle = (startAngle + angle / 2) * Math.PI / 180;
                                const labelR = radius * 0.6;
                                const lx = cx + labelR * Math.cos(midAngle);
                                const ly = cy + labelR * Math.sin(midAngle);
                                labelPositions.push({ x: lx, y: ly, count: count });
                            }
                            startAngle = endAngle;
                        }
                    });

                    if (showLabels) {
                        labelPositions.forEach(pos => {
                            svg += `<text x="${pos.x}" y="${pos.y}" text-anchor="middle" dominant-baseline="middle"
                                    fill="white" font-size="14" font-weight="bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.9); pointer-events: none;">${pos.count}</text>`;
                        });
                    }
                }

                svg += `<circle cx="${cx}" cy="${cy}" r="${radius-1}" fill="none" stroke="white" stroke-width="2"/>`;
                svg += '</svg>';
                return svg;
            }

            // Function to show crop info panel
            function showCropInfoPanel(cropName) {
                const panel = document.getElementById('crop-info-panel');
                let html = `<div style="font-weight: bold; font-size: 14px; color: ${cropColors[cropName]}; margin-bottom: 10px; border-bottom: 2px solid ${cropColors[cropName]}; padding-bottom: 5px;">
                    <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${cropColors[cropName]}; margin-right: 8px;"></span>${cropName}
                </div>`;

                let grandTotal = 0;
                const locations = ['Kabri', 'Kfar Menahem', 'Kedma', 'Gilat'];
                locations.forEach(loc => {
                    const count = cropDist[loc] ? (cropDist[loc][cropName] || 0) : 0;
                    grandTotal += count;
                    if (count > 0) {
                        html += `<div style="padding: 4px 0; font-size: 13px;"><strong>${loc}:</strong> ${count} samples</div>`;
                    }
                });

                html += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; font-weight: bold; font-size: 13px;">Total: ${grandTotal} samples</div>`;
                html += `<div style="margin-top: 10px; font-size: 11px; color: #666; cursor: pointer;" onclick="document.getElementById('crop-info-panel').style.display='none';">Click to close</div>`;

                panel.innerHTML = html;
                panel.style.display = 'block';
            }

            // Function to toggle location display mode
            function toggleLocationView(locName) {
                // Check if location has only one crop - don't toggle if so
                const crops = cropDist[locName] || {};
                const activeCrops = Object.entries(crops).filter(([crop, count]) => count > 0);
                if (activeCrops.length <= 1) {
                    // Single-crop location - do nothing on text label click
                    // (clicking on pie chart shows info panel instead)
                    return;
                }

                const currentState = locationStates[locName];
                locationStates[locName] = currentState === 'total' ? 'detailed' : 'total';
                updatePieChart(locName);
            }

            // Function to update pie chart and label
            function updatePieChart(locName) {
                const showLabels = locationStates[locName] === 'detailed';
                const crops = cropDist[locName] || {};
                const total = locTotals[locName] || 0;
                const maxCount = Math.max(...Object.values(locTotals));
                const minRadius = 25;
                const maxRadius = 55;
                const radius = minRadius + (total / maxCount) * (maxRadius - minRadius);

                // Update pie chart
                if (pieMarkers[locName]) {
                    const newSvg = createPieChartSvg(crops, radius, locName, showLabels);
                    pieMarkers[locName].getElement().querySelector('div').innerHTML = newSvg;
                    attachPieClickHandlers();
                }

                // Update count label - hide if showing detailed
                if (countMarkers[locName]) {
                    const countEl = countMarkers[locName].getElement();
                    if (countEl) {
                        countEl.style.display = showLabels ? 'none' : 'block';
                    }
                }
            }

            // Attach click handlers to pie segments
            function attachPieClickHandlers() {
                document.querySelectorAll('.pie-segment').forEach(segment => {
                    segment.onclick = function(e) {
                        e.stopPropagation();
                        const crop = this.getAttribute('data-crop');
                        if (crop) showCropInfoPanel(crop);
                    };
                });
            }

            // Initialize map
            const map = L.map('israel-map', {
                center: [32.2, 35.0],
                zoom: 8,
                zoomControl: false,
                dragging: false,
                touchZoom: false,
                doubleClickZoom: false,
                scrollWheelZoom: false,
                boxZoom: false,
                keyboard: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const maxCount = Math.max(...Object.values(locTotals));
            const minRadius = 25;
            const maxRadius = 55;

            // Add pie chart circles for each location
            Object.keys(locationsData).forEach(locName => {
                const loc = locationsData[locName];
                const total = locTotals[locName] || 0;
                const crops = cropDist[locName] || {};
                const offset = labelOffsets[locName] || {x: 0, y: -60, arrow: 'down'};
                const radius = minRadius + (total / maxCount) * (maxRadius - minRadius);
                const latOffset = offset.latOffset || 0;
                const lonOffset = offset.lonOffset || 0;
                const adjustedLat = loc.lat + latOffset;
                const adjustedLon = loc.lon + lonOffset;
                const pieChartSvg = createPieChartSvg(crops, radius, locName, false);
                const zIndex = offset.zIndex || 100;

                // Pie chart marker
                const pieMarker = L.marker([adjustedLat, adjustedLon], {
                    icon: L.divIcon({
                        className: 'pie-chart-marker',
                        html: `<div>${pieChartSvg}</div>`,
                        iconSize: [radius * 2, radius * 2],
                        iconAnchor: [radius, radius]
                    }),
                    zIndexOffset: zIndex
                }).addTo(map);
                pieMarkers[locName] = pieMarker;

                // Add click handler to pie marker for single-crop locations
                const activeCrops = Object.entries(crops).filter(([crop, count]) => count > 0);
                if (activeCrops.length === 1) {
                    pieMarker.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        showCropInfoPanel(activeCrops[0][0]);
                    });
                } else {
                    // Multi-crop locations toggle view on marker click
                    pieMarker.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        toggleLocationView(locName);
                    });
                }

                // Count label marker
                // For single-crop locations, use different className so CSS disables pointer-events on Leaflet wrapper
                const countClassName = activeCrops.length === 1 ? 'count-label-single' : 'count-label';
                const pointerStyle = activeCrops.length === 1 ? 'pointer-events: none;' : 'cursor: pointer;';
                const countMarker = L.marker([adjustedLat, adjustedLon], {
                    icon: L.divIcon({
                        className: countClassName,
                        html: `<div style="
                            color: white; font-size: 13px; font-weight: bold;
                            text-shadow: 1px 1px 3px rgba(0,0,0,0.9), -1px -1px 2px rgba(0,0,0,0.5);
                            text-align: center; width: ${radius * 2}px; line-height: ${radius * 2}px;
                            ${pointerStyle}
                        ">${total}</div>`,
                        iconSize: [radius * 2, radius * 2],
                        iconAnchor: [radius, radius]
                    }),
                    zIndexOffset: zIndex + 10
                }).addTo(map);
                countMarkers[locName] = countMarker;

                // Add click handler to count marker for multi-crop locations only
                if (activeCrops.length > 1) {
                    countMarker.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        toggleLocationView(locName);
                    });
                }

                // Arrow SVG
                const arrowSvg = offset.arrow === 'left'
                    ? `<svg width="60" height="20" style="position: absolute; left: -65px; top: 50%; transform: translateY(-50%);">
                        <line x1="55" y1="10" x2="5" y2="10" stroke="#1B5E20" stroke-width="2"/>
                        <polygon points="5,10 12,6 12,14" fill="#1B5E20"/>
                       </svg>`
                    : `<svg width="60" height="20" style="position: absolute; right: -65px; top: 50%; transform: translateY(-50%);">
                        <line x1="5" y1="10" x2="55" y2="10" stroke="#1B5E20" stroke-width="2"/>
                        <polygon points="55,10 48,6 48,14" fill="#1B5E20"/>
                       </svg>`;

                // Location label with click handler
                const labelPadding = offset.padding || '8px 14px';
                const labelMarker = L.marker([adjustedLat, adjustedLon], {
                    icon: L.divIcon({
                        className: 'location-label',
                        html: `<div class="loc-label" data-location="${locName}" style="
                            position: relative; display: inline-block; cursor: pointer;
                            background: rgba(27, 94, 32, 0.95); color: white;
                            padding: ${labelPadding}; border-radius: 4px;
                            font-size: 12px; font-weight: bold; white-space: nowrap;
                            text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                            transform: translate(${offset.x}px, ${offset.y}px);
                        ">${locName}${arrowSvg}</div>`,
                        iconSize: [0, 0],
                        iconAnchor: [0, 0]
                    }),
                    zIndexOffset: zIndex + 20
                }).addTo(map);
            });

            // Attach click handlers after markers are added
            setTimeout(() => {
                attachPieClickHandlers();

                // Attach click handlers to location labels
                document.querySelectorAll('.loc-label').forEach(label => {
                    label.onclick = function(e) {
                        e.stopPropagation();
                        const locName = this.getAttribute('data-location');
                        if (locName) toggleLocationView(locName);
                    };
                });
            }, 100);

            // Close info panel when clicking elsewhere on map
            map.on('click', function() {
                document.getElementById('crop-info-panel').style.display = 'none';
            });
        })();
    </script>
    
            </div>
        </div>
    </div>
</body>
</html>